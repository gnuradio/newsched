{%- macro type_lookup(type, default) -%}
{%- if type in ['int', 'uint32_t', 'int32_t', 'size_t',  'unsigned', 'unsigned int', 'long', 'unsigned long', 'long long', 'unsigned long long']  -%}int
{%- elif type in ['short', 'unsigned short', 'uint16_t', 'int16_t'] -%}short
{%- elif type in ['uint8_t', 'int8_t', 'byte', 'char', 'unsigned char'] -%}byte
{%- elif type in ['std::complex<float>', 'gr_complex'] -%}complex
{%- elif type in ['float'] -%}float
{%- elif type in ['const char *', 'const std::string&'] -%}string
{%- elif type in ['bool'] -%}bool
{%- elif type in ['gui_hint'] -%}gui_hint
{%- else -%}{{default}}{%-endif-%}
{%- endmacro -%}
{% macro get_linked_value(value, ports, parameters, typekeys) -%}
    {% set newvalue = value -%}
    {% if '/' in value | string() -%}
        {% set list1 = value.split('/') -%}
        {% set newvalue = '${' + list1[1] + '}' -%}
        {# {% if list1[0] == 'typekeys' %}
        # {% set newvalue = '${' + list1[1] + '}' %}{% endif -%} #}
    {%- endif -%}
{{newvalue}}{% endmacro -%}
id: {{module}}_{% if grc and 'id' in grc %}{{grc['id']}}{% else %}{{block}}{%endif%}
label: '[{{module}}] {% if grc and 'label' in grc %}{{grc['label']}}{% else %}{{label if label else block}}{%endif%}'
{% if grc %}flags: {{grc['flags']}}{% else %}flags: [python]{% endif %}
category: '[newsched]/{{module}}'

parameters:
{% if typekeys -%} {# We have a templated block, enable type parameter#}
{% for key in typekeys -%}
-   id: {{key['id']}}
    label: {% if 'label' in key %}{{key['label']}}{% else %}IO Type{% endif %}
    dtype: enum
    options: [{% for opt in key['options'] %}{{type_lookup(opt['value'],opt['value'])}}{{"," if not loop.last}} {% endfor %}]
    option_attributes:
        fcn: [{% for opt in key['options'] %}{{opt['suffix']}}{{"," if not loop.last}} {% endfor %}]
    hide: part
{% endfor %}
{% endif -%}
{% for param in parameters -%}
{% if 'grc' not in param or ('hide' in param['grc'] and param['grc']['hide'] != 'all') -%}
-   id: {{param['id']}}
    label: {{param['label']}}
    dtype: {{type_lookup(param['dtype'],'raw')}}
    default: {%if 'grc' in param and 'default' in param['grc']%}{{param['grc']['default']}}{%elif 'default' in param %}{{param['default']}}{%endif%}
    {%if 'grc' in param and 'hide' in param['grc']%}hide: {{param['grc']['hide']}}{%endif%}
{%endif-%}
{% endfor -%}
{% if grc and 'parameters' in grc -%}
{% for param in grc['parameters'] -%}
-   id: {{param['id']}}
    label: {{param['label']}}
    dtype: {{param['dtype']}}
    {% if 'default' in param %}default: {{param['default']}}{%endif%}
    {% if 'hide' in param %}hide: {{param['hide']}}{%endif%}
{% endfor -%}
{% endif -%}

inputs:
{% for port in ports -%}
{% if port['direction'] == 'input'-%}
-   domain: {{port['domain']}}
    dtype: {{type_lookup(get_linked_value(port['type']),get_linked_value(port['type']))}}
    {%if 'dims' in port %}vlen: {{get_linked_value(port['dims'])}}{% endif %}
    {%if 'multiplicity' in port %}multiplicity: {{get_linked_value(port['multiplicity'])}}{% endif -%}
{% endif -%}
{% endfor %}

outputs:
{% for port in ports -%}
{% if port['direction'] == 'output'-%}
-   domain: {{port['domain']}}
    dtype: {{type_lookup(get_linked_value(port['type']),get_linked_value(port['type']))}}
    {%if 'dims' in port %}vlen: {{get_linked_value(port['dims'])}}{% endif -%}
    {%if 'multiplicity' in port %}multiplicity: {{get_linked_value(port['multiplicity'])}}{% endif %}
{% endif -%}
{% endfor -%}

{% if grc -%}
templates:
    imports: |-
{{grc['templates']['imports'] | indent(width=8,first=True)}}
    make: |- 
{{grc['templates']['make'] | indent(width=8,first=True)}}
{% else -%}{# Do the default template #}
templates:
    imports: from newsched import {{module}}
    make: {{module}}.{{block}}(
        {%- for param in parameters -%}
          {%- if 'cotr' not in p or p['cotr'] -%}
            {{'${'}}{{param['id']}}{{'}'}}{{',' if not loop.last}}
        {%- endif -%}
        {%-endfor-%})
{% endif -%}

file_format: 1 {# TODO - should this increment for GR 4.0 #}
